
R version 4.3.2 (2023-10-31) -- "Eye Holes"
Copyright (C) 2023 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

[Previously saved workspace restored]

> ###############################################################################
> # example utilizing `base_mlp` with covariates for 2018
> # packages
> library(brulee)
> library(recipes)
Loading required package: dplyr

Attaching package: ‘dplyr’

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union


Attaching package: ‘recipes’

The following object is masked from ‘package:stats’:

    step

> library(yardstick)
> library(ggplot2)
> library(torch)
> library(tune)
> library(caret)
Loading required package: lattice

Attaching package: ‘caret’

The following objects are masked from ‘package:yardstick’:

    precision, recall, sensitivity, specificity

> library(tidymodels)
── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──
✔ broom        1.0.5     ✔ rsample      1.2.1
✔ dials        1.2.1     ✔ tibble       3.2.1
✔ infer        1.0.7     ✔ tidyr        1.3.1
✔ modeldata    1.3.0     ✔ workflows    1.1.4
✔ parsnip      1.2.1     ✔ workflowsets 1.1.0
✔ purrr        1.0.2     
── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ purrr::discard()     masks scales::discard()
✖ dplyr::filter()      masks stats::filter()
✖ dplyr::lag()         masks stats::lag()
✖ purrr::lift()        masks caret::lift()
✖ caret::precision()   masks yardstick::precision()
✖ caret::recall()      masks yardstick::recall()
✖ caret::sensitivity() masks yardstick::sensitivity()
✖ caret::specificity() masks yardstick::specificity()
✖ recipes::step()      masks stats::step()
• Search for functions across packages at https://www.tidymodels.org/find/
> library(workflows)
> library(rsample)
> library(dplyr)
> library(ggpubr)
> library(ggpointdensity)
> library(viridis)
Loading required package: viridisLite

Attaching package: ‘viridis’

The following object is masked from ‘package:scales’:

    viridis_pal

> 
> setwd("/ddn/gs1/home/manwareme/scratch")
> getwd()
[1] "/ddn/gs1/home/manwareme/scratch"
> source("./beethoven/rtorch/brulee_function.R")
> 
> # files <- list.files(
> #   "/ddn/gs1/group/set/Projects/NRT-AP-Model/output",
> #   full.names = TRUE,
> #   pattern = ".rds"
> # )
> # files
> 
> # # omit "old files" and NDVI data (16 day intervals)
> # files_sub <- files[-c(10, 13, 15, 20)]
> # files_sub
> 
> # files_list <- list(
> #   files_sub[1:5],
> #   files_sub[6:10],
> #   files_sub[11:17]
> # )
> # files_list
> 
> # covar_f <- NULL
> # for (l in seq_along(files_list)) {
> #   covar_l <- covariates_data_frame(
> #     files_sub,
> #     type = "rds",
> #     id = "site_id",
> #     dates = c("2018-01-01", "2018-12-31"),
> #     sample = NULL
> #   )
> #   head(covar_l[, 1:5])
> #   ncol(covar_l)
> #   length(unique(covar_l$site_id))
> #   length(unique(covar_l$time))
> # }
> 
> # saveRDS(
> #   covar,
> #   "./beethoven/rtorch/data/covar.rds"
> # )
> 
> # import covariate data (all but NDVI data)
> beethoven_data <- readRDS("./beethoven/rtorch/data/beethoven_data.rds")
> 
> # remove columns with missing data
> beethoven_data <- beethoven_data[, !colSums(is.na(beethoven_data)) > 0]
> 
> # sample for local development
> # sample_id <- sample(unique(beethoven_data$site_id), 20)
> # beethoven_sample <- beethoven_data[
> #   beethoven_data$site_id %in% sample_id,
> # ]
> # nrow(beethoven_sample)
> # ncol(beethoven_sample)
> 
> # build recipe
> beethoven_recipe <- recipe(beethoven_data, pm2.5 ~ .) |>
+   update_role(time, site_id, new_role = "ID") |>
+   update_role(pm2.5, new_role = "outcome") |>
+   step_zv(all_predictors()) |>
+   step_normalize(all_predictors())
> 
> print(beethoven_recipe$var_info, n = nrow(beethoven_recipe$var_info))
# A tibble: 368 × 4
    variable          type      role      source  
    <chr>             <list>    <chr>     <chr>   
  1 site_id           <chr [3]> ID        original
  2 time              <chr [1]> ID        original
  3 DUM_E2052_0_00000 <chr [2]> predictor original
  4 DUM_E2053_0_00000 <chr [2]> predictor original
  5 DUM_E2062_0_00000 <chr [2]> predictor original
  6 DUM_E2071_0_00000 <chr [2]> predictor original
  7 DUM_E2081_0_00000 <chr [2]> predictor original
  8 DUM_E2082_0_00000 <chr [2]> predictor original
  9 DUM_E2083_0_00000 <chr [2]> predictor original
 10 DUM_E2084_0_00000 <chr [2]> predictor original
 11 DUM_E2085_0_00000 <chr [2]> predictor original
 12 DUM_E2092_0_00000 <chr [2]> predictor original
 13 DUM_E2093_0_00000 <chr [2]> predictor original
 14 DUM_E2094_0_00000 <chr [2]> predictor original
 15 DUM_E2095_0_00000 <chr [2]> predictor original
 16 DUM_E2096_0_00000 <chr [2]> predictor original
 17 DUM_E2101_0_00000 <chr [2]> predictor original
 18 DUM_E2102_0_00000 <chr [2]> predictor original
 19 DUM_E2111_0_00000 <chr [2]> predictor original
 20 DUM_E2121_0_00000 <chr [2]> predictor original
 21 DUM_E2154_0_00000 <chr [2]> predictor original
 22 DUM_E3001_0_00000 <chr [2]> predictor original
 23 DUM_E3002_0_00000 <chr [2]> predictor original
 24 DUM_E3003_0_00000 <chr [2]> predictor original
 25 DUM_E3004_0_00000 <chr [2]> predictor original
 26 DUM_E3005_0_00000 <chr [2]> predictor original
 27 DUM_E3006_0_00000 <chr [2]> predictor original
 28 DUM_E3007_0_00000 <chr [2]> predictor original
 29 DUM_E3008_0_00000 <chr [2]> predictor original
 30 DUM_E3009_0_00000 <chr [2]> predictor original
 31 DUM_E3010_0_00000 <chr [2]> predictor original
 32 DUM_E3011_0_00000 <chr [2]> predictor original
 33 DUM_E3012_0_00000 <chr [2]> predictor original
 34 DUM_E3013_0_00000 <chr [2]> predictor original
 35 DUM_E3014_0_00000 <chr [2]> predictor original
 36 DUM_E3015_0_00000 <chr [2]> predictor original
 37 DUM_E3017_0_00000 <chr [2]> predictor original
 38 DUM_E3018_0_00000 <chr [2]> predictor original
 39 DUM_E3020_0_00000 <chr [2]> predictor original
 40 DUM_E3021_0_00000 <chr [2]> predictor original
 41 DUM_E3022_0_00000 <chr [2]> predictor original
 42 DUM_E3024_0_00000 <chr [2]> predictor original
 43 DUM_E3025_0_00000 <chr [2]> predictor original
 44 DUM_E3026_0_00000 <chr [2]> predictor original
 45 DUM_E3027_0_00000 <chr [2]> predictor original
 46 DUM_E3029_0_00000 <chr [2]> predictor original
 47 DUM_E3031_0_00000 <chr [2]> predictor original
 48 DUM_E3032_0_00000 <chr [2]> predictor original
 49 DUM_E3033_0_00000 <chr [2]> predictor original
 50 DUM_E3034_0_00000 <chr [2]> predictor original
 51 DUM_E3035_0_00000 <chr [2]> predictor original
 52 DUM_E3036_0_00000 <chr [2]> predictor original
 53 DUM_E3037_0_00000 <chr [2]> predictor original
 54 DUM_E3039_0_00000 <chr [2]> predictor original
 55 DUM_E3040_0_00000 <chr [2]> predictor original
 56 DUM_E3042_0_00000 <chr [2]> predictor original
 57 DUM_E3043_0_00000 <chr [2]> predictor original
 58 DUM_E3045_0_00000 <chr [2]> predictor original
 59 DUM_E3046_0_00000 <chr [2]> predictor original
 60 DUM_E3047_0_00000 <chr [2]> predictor original
 61 DUM_E3048_0_00000 <chr [2]> predictor original
 62 DUM_E3050_0_00000 <chr [2]> predictor original
 63 DUM_E3051_0_00000 <chr [2]> predictor original
 64 DUM_E3052_0_00000 <chr [2]> predictor original
 65 DUM_E3053_0_00000 <chr [2]> predictor original
 66 DUM_E3054_0_00000 <chr [2]> predictor original
 67 DUM_E3055_0_00000 <chr [2]> predictor original
 68 DUM_E3056_0_00000 <chr [2]> predictor original
 69 DUM_E3057_0_00000 <chr [2]> predictor original
 70 DUM_E3058_0_00000 <chr [2]> predictor original
 71 DUM_E3059_0_00000 <chr [2]> predictor original
 72 DUM_E3060_0_00000 <chr [2]> predictor original
 73 DUM_E3061_0_00000 <chr [2]> predictor original
 74 DUM_E3062_0_00000 <chr [2]> predictor original
 75 DUM_E3063_0_00000 <chr [2]> predictor original
 76 DUM_E3064_0_00000 <chr [2]> predictor original
 77 DUM_E3065_0_00000 <chr [2]> predictor original
 78 DUM_E3066_0_00000 <chr [2]> predictor original
 79 DUM_E3067_0_00000 <chr [2]> predictor original
 80 DUM_E3068_0_00000 <chr [2]> predictor original
 81 DUM_E3069_0_00000 <chr [2]> predictor original
 82 DUM_E3070_0_00000 <chr [2]> predictor original
 83 DUM_E3071_0_00000 <chr [2]> predictor original
 84 DUM_E3072_0_00000 <chr [2]> predictor original
 85 DUM_E3073_0_00000 <chr [2]> predictor original
 86 DUM_E3074_0_00000 <chr [2]> predictor original
 87 DUM_E3075_0_00000 <chr [2]> predictor original
 88 DUM_E3076_0_00000 <chr [2]> predictor original
 89 DUM_E3077_0_00000 <chr [2]> predictor original
 90 DUM_E3078_0_00000 <chr [2]> predictor original
 91 DUM_E3079_0_00000 <chr [2]> predictor original
 92 DUM_E3080_0_00000 <chr [2]> predictor original
 93 DUM_E3081_0_00000 <chr [2]> predictor original
 94 DUM_E3082_0_00000 <chr [2]> predictor original
 95 DUM_E3083_0_00000 <chr [2]> predictor original
 96 DUM_E3084_0_00000 <chr [2]> predictor original
 97 DUM_E3085_0_00000 <chr [2]> predictor original
 98 GEO_COVMR_0_00000 <chr [2]> predictor original
 99 GEO_NOVMR_0_00000 <chr [2]> predictor original
100 GEO_OZVMR_0_00000 <chr [2]> predictor original
101 GEO_SOVMR_0_00000 <chr [2]> predictor original
102 GEO_ACETO_0_00000 <chr [2]> predictor original
103 GEO_ACETA_0_00000 <chr [2]> predictor original
104 GEO_CALKA_0_00000 <chr [2]> predictor original
105 GEO_HIBCA_0_00000 <chr [2]> predictor original
106 GEO_HOBCA_0_00000 <chr [2]> predictor original
107 GEO_BENZE_0_00000 <chr [2]> predictor original
108 GEO_ETHTE_0_00000 <chr [2]> predictor original
109 GEO_PROPA_0_00000 <chr [2]> predictor original
110 GEO_METHA_0_00000 <chr [2]> predictor original
111 GEO_CMONO_0_00000 <chr [2]> predictor original
112 GEO_DUST1_0_00000 <chr [2]> predictor original
113 GEO_DUST2_0_00000 <chr [2]> predictor original
114 GEO_DUST3_0_00000 <chr [2]> predictor original
115 GEO_DUST4_0_00000 <chr [2]> predictor original
116 GEO_ETHOL_0_00000 <chr [2]> predictor original
117 GEO_FORMA_0_00000 <chr [2]> predictor original
118 GEO_NITAC_0_00000 <chr [2]> predictor original
119 GEO_PERAC_0_00000 <chr [2]> predictor original
120 GEO_ISOPR_0_00000 <chr [2]> predictor original
121 GEO_METHC_0_00000 <chr [2]> predictor original
122 GEO_MEKET_0_00000 <chr [2]> predictor original
123 GEO_MVKET_0_00000 <chr [2]> predictor original
124 GEO_DIPEN_0_00000 <chr [2]> predictor original
125 GEO_AMNIA_0_00000 <chr [2]> predictor original
126 GEO_AMNUM_0_00000 <chr [2]> predictor original
127 GEO_INNIT_0_00000 <chr [2]> predictor original
128 GEO_NIOXI_0_00000 <chr [2]> predictor original
129 GEO_NIDIO_0_00000 <chr [2]> predictor original
130 GEO_HIORG_0_00000 <chr [2]> predictor original
131 GEO_HOORG_0_00000 <chr [2]> predictor original
132 GEO_PERNI_0_00000 <chr [2]> predictor original
133 GEO_PM25X_0_00000 <chr [2]> predictor original
134 GEO_PM25R_0_00000 <chr [2]> predictor original
135 GEO_BLCPM_0_00000 <chr [2]> predictor original
136 GEO_DUSPM_0_00000 <chr [2]> predictor original
137 GEO_NITPM_0_00000 <chr [2]> predictor original
138 GEO_ORCPM_0_00000 <chr [2]> predictor original
139 GEO_SORPM_0_00000 <chr [2]> predictor original
140 GEO_SEAPM_0_00000 <chr [2]> predictor original
141 GEO_SULPM_0_00000 <chr [2]> predictor original
142 GEO_CALKE_0_00000 <chr [2]> predictor original
143 GEO_CALDH_0_00000 <chr [2]> predictor original
144 GEO_FSEAS_0_00000 <chr [2]> predictor original
145 GEO_CSEAS_0_00000 <chr [2]> predictor original
146 GEO_SULDI_0_00000 <chr [2]> predictor original
147 GEO_SOAPR_0_00000 <chr [2]> predictor original
148 GEO_SOASI_0_00000 <chr [2]> predictor original
149 GEO_TOLUE_0_00000 <chr [2]> predictor original
150 GEO_XYLEN_0_00000 <chr [2]> predictor original
151 GEO_HYPER_0_00000 <chr [2]> predictor original
152 GEO_NITRO_0_00000 <chr [2]> predictor original
153 LDU_EBE15_0_00000 <chr [2]> predictor original
154 LDU_EBE30_0_00000 <chr [2]> predictor original
155 LDU_EBE75_0_00000 <chr [2]> predictor original
156 LDU_EMX15_0_00000 <chr [2]> predictor original
157 LDU_EMX30_0_00000 <chr [2]> predictor original
158 LDU_EMX75_0_00000 <chr [2]> predictor original
159 LDU_EMN15_0_00000 <chr [2]> predictor original
160 LDU_EMN30_0_00000 <chr [2]> predictor original
161 LDU_EMN75_0_00000 <chr [2]> predictor original
162 LDU_EMD15_0_00000 <chr [2]> predictor original
163 LDU_EMD30_0_00000 <chr [2]> predictor original
164 LDU_EMD75_0_00000 <chr [2]> predictor original
165 LDU_EMI15_0_00000 <chr [2]> predictor original
166 LDU_EMI30_0_00000 <chr [2]> predictor original
167 LDU_EMI75_0_00000 <chr [2]> predictor original
168 LDU_ESD15_0_00000 <chr [2]> predictor original
169 LDU_ESD30_0_00000 <chr [2]> predictor original
170 LDU_ESD75_0_00000 <chr [2]> predictor original
171 LDU_EDS15_0_00000 <chr [2]> predictor original
172 LDU_EDS30_0_00000 <chr [2]> predictor original
173 LDU_EDS75_0_00000 <chr [2]> predictor original
174 OTH_HMSWL_0_00000 <chr [2]> predictor original
175 OTH_HMSWM_0_00000 <chr [2]> predictor original
176 OTH_HMSWH_0_00000 <chr [2]> predictor original
177 DUM_CLRGA_0_00000 <chr [2]> predictor original
178 DUM_CLRGB_0_00000 <chr [2]> predictor original
179 DUM_CLRGC_0_00000 <chr [2]> predictor original
180 DUM_CLRGD_0_00000 <chr [2]> predictor original
181 DUM_CLRGE_0_00000 <chr [2]> predictor original
182 MOD_CSZAN_0_00000 <chr [2]> predictor original
183 MOD_CVZAN_0_00000 <chr [2]> predictor original
184 MOD_RAZAN_0_00000 <chr [2]> predictor original
185 MOD_SCTAN_0_00000 <chr [2]> predictor original
186 MOD_GLNAN_0_00000 <chr [2]> predictor original
187 MOD_CSZAN_0_01000 <chr [2]> predictor original
188 MOD_CVZAN_0_01000 <chr [2]> predictor original
189 MOD_RAZAN_0_01000 <chr [2]> predictor original
190 MOD_SCTAN_0_01000 <chr [2]> predictor original
191 MOD_GLNAN_0_01000 <chr [2]> predictor original
192 MOD_CSZAN_0_10000 <chr [2]> predictor original
193 MOD_CVZAN_0_10000 <chr [2]> predictor original
194 MOD_RAZAN_0_10000 <chr [2]> predictor original
195 MOD_SCTAN_0_10000 <chr [2]> predictor original
196 MOD_GLNAN_0_10000 <chr [2]> predictor original
197 MOD_CSZAN_0_50000 <chr [2]> predictor original
198 MOD_CVZAN_0_50000 <chr [2]> predictor original
199 MOD_RAZAN_0_50000 <chr [2]> predictor original
200 MOD_SCTAN_0_50000 <chr [2]> predictor original
201 MOD_GLNAN_0_50000 <chr [2]> predictor original
202 MOD_AD4TA_0_00000 <chr [2]> predictor original
203 MOD_AD5TA_0_00000 <chr [2]> predictor original
204 MOD_AD4TA_0_01000 <chr [2]> predictor original
205 MOD_AD5TA_0_01000 <chr [2]> predictor original
206 MOD_AD4TA_0_10000 <chr [2]> predictor original
207 MOD_AD5TA_0_10000 <chr [2]> predictor original
208 MOD_AD4TA_0_50000 <chr [2]> predictor original
209 MOD_AD5TA_0_50000 <chr [2]> predictor original
210 MOD_CLCVD_0_00000 <chr [2]> predictor original
211 MOD_CLCVN_0_00000 <chr [2]> predictor original
212 MOD_CLCVD_0_01000 <chr [2]> predictor original
213 MOD_CLCVN_0_01000 <chr [2]> predictor original
214 MOD_CLCVD_0_10000 <chr [2]> predictor original
215 MOD_CLCVN_0_10000 <chr [2]> predictor original
216 MOD_CLCVD_0_50000 <chr [2]> predictor original
217 MOD_CLCVN_0_50000 <chr [2]> predictor original
218 MOD_SFRF1_0_00000 <chr [2]> predictor original
219 MOD_SFRF1_0_01000 <chr [2]> predictor original
220 MOD_SFRF1_0_10000 <chr [2]> predictor original
221 MOD_SFRF1_0_50000 <chr [2]> predictor original
222 MOD_SFRF2_0_00000 <chr [2]> predictor original
223 MOD_SFRF2_0_01000 <chr [2]> predictor original
224 MOD_SFRF2_0_10000 <chr [2]> predictor original
225 MOD_SFRF2_0_50000 <chr [2]> predictor original
226 MOD_SFRF3_0_00000 <chr [2]> predictor original
227 MOD_SFRF3_0_01000 <chr [2]> predictor original
228 MOD_SFRF3_0_10000 <chr [2]> predictor original
229 MOD_SFRF3_0_50000 <chr [2]> predictor original
230 MOD_SFRF4_0_00000 <chr [2]> predictor original
231 MOD_SFRF4_0_01000 <chr [2]> predictor original
232 MOD_SFRF4_0_10000 <chr [2]> predictor original
233 MOD_SFRF4_0_50000 <chr [2]> predictor original
234 MOD_SFRF5_0_00000 <chr [2]> predictor original
235 MOD_SFRF5_0_01000 <chr [2]> predictor original
236 MOD_SFRF5_0_10000 <chr [2]> predictor original
237 MOD_SFRF5_0_50000 <chr [2]> predictor original
238 MOD_SFRF6_0_00000 <chr [2]> predictor original
239 MOD_SFRF6_0_01000 <chr [2]> predictor original
240 MOD_SFRF6_0_10000 <chr [2]> predictor original
241 MOD_SFRF6_0_50000 <chr [2]> predictor original
242 MOD_SFRF7_0_00000 <chr [2]> predictor original
243 MOD_SFRF7_0_01000 <chr [2]> predictor original
244 MOD_SFRF7_0_10000 <chr [2]> predictor original
245 MOD_SFRF7_0_50000 <chr [2]> predictor original
246 MOD_SFCTD_0_00000 <chr [2]> predictor original
247 MOD_SFCTN_0_00000 <chr [2]> predictor original
248 MOD_SFCTD_0_01000 <chr [2]> predictor original
249 MOD_SFCTN_0_01000 <chr [2]> predictor original
250 MOD_SFCTD_0_10000 <chr [2]> predictor original
251 MOD_SFCTN_0_10000 <chr [2]> predictor original
252 MOD_SFCTD_0_50000 <chr [2]> predictor original
253 MOD_SFCTN_0_50000 <chr [2]> predictor original
254 MET_WEASD_0_00000 <chr [2]> predictor original
255 MET_EVAPE_0_00000 <chr [2]> predictor original
256 MET_APCPA_0_00000 <chr [2]> predictor original
257 MET_AIRSF_0_00000 <chr [2]> predictor original
258 MET_ALBED_0_00000 <chr [2]> predictor original
259 MET_TCDCT_0_00000 <chr [2]> predictor original
260 MET_DSWRF_0_00000 <chr [2]> predictor original
261 MET_HCDCH_0_00000 <chr [2]> predictor original
262 MET_LHTFL_0_00000 <chr [2]> predictor original
263 MET_LCDCL_0_00000 <chr [2]> predictor original
264 MET_MCDCM_0_00000 <chr [2]> predictor original
265 MET_HPBLH_0_00000 <chr [2]> predictor original
266 MET_PRWTR_0_00000 <chr [2]> predictor original
267 MET_PRATE_0_00000 <chr [2]> predictor original
268 MET_PRESS_0_00000 <chr [2]> predictor original
269 MET_SHTFL_0_00000 <chr [2]> predictor original
270 MET_SNOWC_0_00000 <chr [2]> predictor original
271 MET_UWND1_0_00000 <chr [2]> predictor original
272 MET_ULWRF_0_00000 <chr [2]> predictor original
273 MET_VWND1_0_00000 <chr [2]> predictor original
274 MET_VISVI_0_00000 <chr [2]> predictor original
275 MET_WNDSP_0_00000 <chr [2]> predictor original
276 MET_OMEGA_0_00000 <chr [2]> predictor original
277 MET_SHUMS_0_00000 <chr [2]> predictor original
278 MET_AIRSF_1_00000 <chr [2]> predictor original
279 MET_APCPA_1_00000 <chr [2]> predictor original
280 MET_PRESS_1_00000 <chr [2]> predictor original
281 MET_WNDSP_1_00000 <chr [2]> predictor original
282 MET_SHUMS_1_00000 <chr [2]> predictor original
283 TRF_NEINP_0_00000 <chr [2]> predictor original
284 LDU_TWATR_0_00100 <chr [2]> predictor original
285 LDU_TDVOS_0_00100 <chr [2]> predictor original
286 LDU_TDVLO_0_00100 <chr [2]> predictor original
287 LDU_TDVMI_0_00100 <chr [2]> predictor original
288 LDU_TDVHI_0_00100 <chr [2]> predictor original
289 LDU_TBARN_0_00100 <chr [2]> predictor original
290 LDU_TDFOR_0_00100 <chr [2]> predictor original
291 LDU_TEFOR_0_00100 <chr [2]> predictor original
292 LDU_TMFOR_0_00100 <chr [2]> predictor original
293 LDU_TSHRB_0_00100 <chr [2]> predictor original
294 LDU_THERB_0_00100 <chr [2]> predictor original
295 LDU_TPAST_0_00100 <chr [2]> predictor original
296 LDU_TPLNT_0_00100 <chr [2]> predictor original
297 LDU_TWDWT_0_00100 <chr [2]> predictor original
298 LDU_THWEM_0_00100 <chr [2]> predictor original
299 LDU_TUNCL_0_01000 <chr [2]> predictor original
300 LDU_TWATR_0_01000 <chr [2]> predictor original
301 LDU_TDVOS_0_01000 <chr [2]> predictor original
302 LDU_TDVLO_0_01000 <chr [2]> predictor original
303 LDU_TDVMI_0_01000 <chr [2]> predictor original
304 LDU_TDVHI_0_01000 <chr [2]> predictor original
305 LDU_TBARN_0_01000 <chr [2]> predictor original
306 LDU_TDFOR_0_01000 <chr [2]> predictor original
307 LDU_TEFOR_0_01000 <chr [2]> predictor original
308 LDU_TMFOR_0_01000 <chr [2]> predictor original
309 LDU_TSHRB_0_01000 <chr [2]> predictor original
310 LDU_THERB_0_01000 <chr [2]> predictor original
311 LDU_TPAST_0_01000 <chr [2]> predictor original
312 LDU_TPLNT_0_01000 <chr [2]> predictor original
313 LDU_TWDWT_0_01000 <chr [2]> predictor original
314 LDU_THWEM_0_01000 <chr [2]> predictor original
315 LDU_TUNCL_0_10000 <chr [2]> predictor original
316 LDU_TWATR_0_10000 <chr [2]> predictor original
317 LDU_TDVOS_0_10000 <chr [2]> predictor original
318 LDU_TDVLO_0_10000 <chr [2]> predictor original
319 LDU_TDVMI_0_10000 <chr [2]> predictor original
320 LDU_TDVHI_0_10000 <chr [2]> predictor original
321 LDU_TBARN_0_10000 <chr [2]> predictor original
322 LDU_TDFOR_0_10000 <chr [2]> predictor original
323 LDU_TEFOR_0_10000 <chr [2]> predictor original
324 LDU_TMFOR_0_10000 <chr [2]> predictor original
325 LDU_TSHRB_0_10000 <chr [2]> predictor original
326 LDU_THERB_0_10000 <chr [2]> predictor original
327 LDU_TPAST_0_10000 <chr [2]> predictor original
328 LDU_TPLNT_0_10000 <chr [2]> predictor original
329 LDU_TWDWT_0_10000 <chr [2]> predictor original
330 LDU_THWEM_0_10000 <chr [2]> predictor original
331 GRD_TOTAL_0_01000 <chr [2]> predictor original
332 GRD_DENKM_0_01000 <chr [2]> predictor original
333 GRD_TOTAL_0_10000 <chr [2]> predictor original
334 GRD_DENKM_0_10000 <chr [2]> predictor original
335 GRD_TOTAL_0_50000 <chr [2]> predictor original
336 GRD_DENKM_0_50000 <chr [2]> predictor original
337 OTH_POPDN_0_00100 <chr [2]> predictor original
338 OTH_POPDN_0_01000 <chr [2]> predictor original
339 OTH_POPDN_0_10000 <chr [2]> predictor original
340 DUM_Y2018_0_00000 <chr [2]> predictor original
341 DUM_Y2019_0_00000 <chr [2]> predictor original
342 DUM_Y2020_0_00000 <chr [2]> predictor original
343 DUM_Y2021_0_00000 <chr [2]> predictor original
344 DUM_Y2022_0_00000 <chr [2]> predictor original
345 DUM_JANUA_0_00000 <chr [2]> predictor original
346 DUM_FEBRU_0_00000 <chr [2]> predictor original
347 DUM_MARCH_0_00000 <chr [2]> predictor original
348 DUM_APRIL_0_00000 <chr [2]> predictor original
349 DUM_MAYMA_0_00000 <chr [2]> predictor original
350 DUM_JUNEJ_0_00000 <chr [2]> predictor original
351 DUM_JULYJ_0_00000 <chr [2]> predictor original
352 DUM_AUGUS_0_00000 <chr [2]> predictor original
353 DUM_SEPTE_0_00000 <chr [2]> predictor original
354 DUM_OCTOB_0_00000 <chr [2]> predictor original
355 DUM_NOVEM_0_00000 <chr [2]> predictor original
356 DUM_DECEM_0_00000 <chr [2]> predictor original
357 DUM_WKDY1_0_00000 <chr [2]> predictor original
358 DUM_WKDY2_0_00000 <chr [2]> predictor original
359 DUM_WKDY3_0_00000 <chr [2]> predictor original
360 DUM_WKDY4_0_00000 <chr [2]> predictor original
361 DUM_WKDY5_0_00000 <chr [2]> predictor original
362 DUM_WKDY6_0_00000 <chr [2]> predictor original
363 DUM_WKDY7_0_00000 <chr [2]> predictor original
364 MOD_LGHTN_0_00000 <chr [2]> predictor original
365 MOD_LGHTN_0_01000 <chr [2]> predictor original
366 MOD_LGHTN_0_10000 <chr [2]> predictor original
367 MOD_LGHTN_0_50000 <chr [2]> predictor original
368 pm2.5             <chr [2]> outcome   original
> 
> # set hyperparameters
> epochs <- c(100, 150, 200, 250)
> hidden_units <- list(
+   c(16, 16), c(16, 32), c(32, 32), c(32, 64), c(64, 64)
+ )
> learn_rate <- c(0.01, 0.005, 0.001)
> 
> # implement new function with sample data
> beethoven_mlp <- base_mlp(
+   recipe = beethoven_recipe,
+   data = beethoven_data,
+   epochs = epochs,
+   hidden_units = hidden_units,
+   activation = "relu",
+   learn_rate = learn_rate,
+   folds = 5,
+   importance = "permutations",
+   engine = "brulee",
+   outcome = "regression",
+   metric = "rmse"
+ )
Initializing multilayer perceptron model with tunable hyperparameters...
Applying recipe to model workflow...
Fitting 60 unique models...
Selecting optimal hyperparameters...
Optimal hyperparameters:
# A tibble: 1 × 5
  hidden_units epochs activation learn_rate .config              
  <list>        <dbl> <chr>           <dbl> <chr>                
1 <dbl [2]>       250 relu             0.01 Preprocessor1_Model20
Refitting model with optimal hyperparamters...
Predicting outcomes with refit model and test data...
> 
> # inspect performance
> yardstick::metrics(beethoven_mlp[[2]], pm2.5, .pred)
# A tibble: 3 × 3
  .metric .estimator .estimate
  <chr>   <chr>          <dbl>
1 rmse    standard       3.32 
2 rsq     standard       0.695
3 mae     standard       2.16 
> 
> # inspect model
> beethoven_mlp[[1]]
══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: mlp()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_zv()
• step_normalize()

── Model ───────────────────────────────────────────────────────────────────────
Single Layer Neural Network Model Specification (regression)

Main Arguments:
  hidden_units = c(64, 64)
  epochs = 250
  activation = relu
  learn_rate = 0.01

Engine-Specific Arguments:
  importance = importance

Computational engine: brulee 

> 
> # plot
> ggplot(
+   data = beethoven_mlp[[2]],
+   aes(x = pm2.5, y = .pred)
+ ) +
+   geom_pointdensity() +
+   scale_color_viridis(option = "D", name = "Density Estimation") +
+   geom_smooth(method = "lm", se = TRUE, col = "tomato") +
+   labs(
+     x = "Observed PM2.5",
+     y = "Predicted PM2.5"
+   ) +
+   theme_pubr() +
+   theme(legend.position = "right")
`geom_smooth()` using formula = 'y ~ x'
> 
> # save
> beethoven_filename <- paste0(
+   "./beethoven/rtorch/data/model_output/beethoven_mlp_",
+   format(Sys.time(), "%Y%m%d_%H%M%S"),
+   ".rds"
+ )
> saveRDS(
+   beethoven_mlp,
+   beethoven_filename
+ )
> 
> proc.time()
      user     system    elapsed 
4070878.12 6295690.84   81089.46 
